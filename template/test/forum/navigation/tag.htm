<!--{template forum/navigation/header}-->

<div class="container">
    <div class="row">
        <div class="col-lg-8 col-md-8 col-md-offset-2 col-lg-offset-2">
            <div class="block-items">
                <header>
                    <!--{if $follow_flag}-->
                    <h1>{$lang[block_title]}</h1>
                    <!--{else}-->
                    <h1>{$lang[tag_title]}</h1>
                    <!--{/if}-->
                    <p>{$lang[block_l_title]}</p>
                </header>
                <section class="block-item-list">
                    <div class="item-list-side">
                        <h4>{$lang[item_sort]}</h4>
                        <ul>
                            <li <!--{if $sortid === ''}--> class="item-selected" <!--{/if}-->><a href="/forum.php?mod=navigation&action=tag">{$lang[all_item]}</a></li>
                            <!--{loop $block_sort_list $key $blocks}-->
                            <li <!--{if $key === $sortid}--> class="item-selected"<!--{/if}-->><a href="/forum.php?mod=navigation&action=tag&sortid={$key}">{$blocks[sort_name]}</a></li>
                            <!--{/loop}-->
                        </ul>
                    </div>
                    <div class="row">
                        <!--{loop $block_datas $blocks}-->
                        <!--{loop $blocks[sort_blocks] $block}-->
                        <div class="col-lg-3 col-md-4 col-sm-6 ">
                            <div class='block-item'>
                                <p class="name">$block[block_name]</p>
                                <!--{if $_G[uid] == 1 || $_G[uid] == 1196183 || $_G[uid] == 1215312}--><p class="other"><span>$block[follow_count]</span><span> $lang[follow_count]</span></p><!--{/if}-->
                                <!--{if $follow_flag}-->
                                <button class="follow-tag" value="{$block[block_id]}">{$lang[follow]}</button>
                                <!--{else}-->
                                <!--{if in_array($block[block_id], array_column($follow_ids,'block_id'))}-->
                                <button class="unfollow-tag" value="{$block[block_id]}">{$lang[unfollow]}</button>
                                <!--{else}-->
                                <button class="follow-tag" value="{$block[block_id]}">{$lang[follow]}</button>
                                <!--{/if}-->
                                <!--{/if}-->
                            </div>
                        </div>
                        <!--{/loop}-->
                        <!--{/loop}-->
                    </div>
                </section>
                <footer>
                    <span>{$lang[more_block]}</span>
                </footer>
            </div>
            <div class="get-next">
                <button <!--{if $follow_flag}-->class="disabled-btn"<!--{else}-->class="abled-btn"<!--{/if}-->>{$lang[finish]}</button>
                <!--{if !$follow_flag}-->
                <button class="kouei-back">{$lang[back]}</button>
                <!--{/if}-->
            </div>
        </div>
    </div>
</div>
<script>
    $(function () {
        $('.get-next .kouei-back').click(function () {
            location.href = '/forum.php?mod=navigation';
        });
        $('.block-item-list button').click(function () {
            var tagClassName = $(this)[0].className;
            if (tagClassName == 'follow-tag') {
                $.post('forum.php?mod=navigation&action=tag&type=follow', {
                    'follow_block_id': this.value,
                    'formhash': "{FORMHASH}"
                }, function (results) {
                    var flag = $.parseJSON(results).flag;
                    var code = $.parseJSON(results).code;
                    var bid = $.parseJSON(results).block_id;
                    if (flag) {
                        var oFollowed = $('.block-item-list button[value=' + bid + ']');
                        oFollowed.removeClass().addClass('unfollow-tag').text("{$lang[unfollow]}");
                        var oFollowCount = oFollowed.parent().find("p.other span:first");
                        oFollowCount.text(function(index, value){
                            return parseInt(value) + 1;
                        });
                        var oDb = $('.get-next button:first');
                        if (oDb.length > 0) {
                            oDb.css('background-color', '#007fff');
                            oDb.click(function () {
                                location.href = 'forum.php?mod=navigation';
                            });
                        }
                    } else {
                        if (code == 0) {
                            swal({
                                'title': "{$lang[unknowerror]}",
                                'text': "{$lang[connect_manager]}",
                                'type': 'error',
                                'confirmButtonText': "{$lang[notice][ok]}",
                                'confirmButtonColor': '#DD6B55'
                            });
                        } else if (code == 4) {
                            swal({
                                'title': 'Oops..',
                                'text': "{$lang[followed]}",
                                'type': 'error',
                                'confirmButtonText': "{$lang[notice][ok]}",
                                'confirmButtonColor': '#DD6B55'
                            });
                        }
                    }
                });
            } else if (tagClassName == 'unfollow-tag') {
                $.post('forum.php?mod=navigation&action=tag&type=unfollow', {'unfollow_block_id': this.value}, function (results) {
                    var flag = $.parseJSON(results).flag;
                    var bid = $.parseJSON(results).block_id;
                    if (flag) {
                        var oUnfollowed = $('.block-item-list button[value=' + bid + ']');
                        var oDb = $('.get-next button:first');
                        oUnfollowed.removeClass().addClass('follow-tag').text("{$lang[follow]}");
                        var oUnfollowCount = oUnfollowed.parent().find("p.other span:first");
                        oUnfollowCount.text(function (index, value) {
                            return parseInt(value) - 1;
                        });
                        if (oDb.length > 0) {
                            oDb.css('background-color', '#007fff');
                            oDb.click(function () {
                                location.href = 'forum.php?mod=navigation';
                            });
                            if ($('.block-item-list .unfollow-tag').length == 0) {
                                oDb.css('background-color', '#ddd');
                                oDb.unbind('click');
                            }
                        }
                    } else {
                        swal({
                            'title': "{$lang[unknowerror]}",
                            'text': "{$lang[connect_manager]}",
                            'type': 'error',
                            'confirmButtonText': "{$lang[notice][ok]}",
                            'confirmButtonColor': '#DD6B55'
                        });
                    }
                });
            } else {
                return false;
            }
        });
    });
</script>
<!--{template forum/navigation/footer}-->